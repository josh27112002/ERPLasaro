<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Confirmar Venta - ERP</title>
  <link rel="stylesheet" href="/static/lateral.css" />
  <style>
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }

    .mensaje {
      margin-top: 15px;
      font-weight: bold;
    }

    .success {
      color: green;
    }

    .error {
      color: red;
    }

    @media print {
      body * {
        visibility: hidden;
      }
      .factura-container, .factura-container * {
        visibility: visible;
      }
      .factura-container {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
      }
      .no-print {
        display: none !important;
      }
    }

    .factura-container {
      max-width: 700px;
      margin: 40px auto;
      padding: 20px;
      border: 1px solid #ccc;
      font-family: Arial, sans-serif;
      background-color: white;
    }

    .factura-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      border-bottom: 2px solid #333;
      padding-bottom: 10px;
      margin-bottom: 20px;
    }

    .factura-header .empresa h1 {
      margin: 0;
      font-size: 24px;
    }

    .factura-header .empresa p {
      margin: 2px 0;
      font-size: 14px;
    }

    .factura-tabla {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    .factura-tabla th, .factura-tabla td {
      border: 1px solid #999;
      padding: 10px;
      font-size: 14px;
    }

    .factura-tabla th {
      background-color: #f0f0f0;
    }

    .factura-botones {
      margin-top: 30px;
      display: flex;
      gap: 10px;
    }

    .factura-botones button {
      padding: 10px 20px;
      font-size: 14px;
      cursor: pointer;
    }

    .agradecimiento {
      margin-top: 20px;
      font-style: italic;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-column">
      <span id="usuario-logueado">Bienvenido</span><br>
      <span id="rol-logueado">Rol: </span><br>
      <span id="fecha-hoy"></span>
    </div>
    <div class="header-column center-column">
      <img src="logo3-removebg-preview.png" alt="Logo del ERP" class="logo" />
    </div>
    <div class="header-column right-column">
      <a href="index.html" class="logout" onclick="cerrarSesion()">Cerrar sesi√≥n</a>
    </div>
  </div>

  <div class="content">
    <div class="sidebar">
      <h2>Mi ERP</h2>
      <ul>
        <li><a href="dashboard.html" data-rol="todos">Inicio</a></li>
        <li><a href="ventas.html" data-rol="Administrador,Vendedor,Bodega">Ventas</a></li>
        <li><a href="compras.html" data-rol="Administrador,Bodega">Compras</a></li>
        <li><a href="inventario.html" data-rol="Administrador,Bodega">Inventario</a></li>
        <li><a href="reportes.html" data-rol="Administrador,Bodega">Reportes</a></li>
        <li><a href="usuarios.html" data-rol="Administrador">Usuarios</a></li>
      </ul>
    </div>

    <div class="main">
      <h1>Confirmar Venta</h1>

      <table id="tablaResumen">
        <thead>
          <tr>
            <th>Producto</th>
            <th>Cantidad</th>
            <th>Precio</th>
            <th>Subtotal</th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr>
            <td colspan="3"><strong>Total:</strong></td>
            <td id="totalVenta">Q0.00</td>
          </tr>
        </tfoot>
      </table>

      <div style="margin-top: 20px;">
        <label for="clienteNIT"><strong>NIT del cliente:</strong></label>
        <input type="text" id="clienteNIT" placeholder="1234567-8" style="width: 200px; margin-right: 10px;" />
        <label><input type="checkbox" id="usarCF" /> Usar CF</label>
      </div>

      <button id="btnConfirmarVenta">Confirmar Venta</button>
      <p id="mensaje" class="mensaje"></p>

      <!-- FACTURA -->
      <div id="factura" style="display: none;">
        <div class="factura-container">
          <div class="factura-header">
            <div class="empresa">
              <h1 id="empresaNombre">Mi Empresa</h1>
              <p><strong>NIT:</strong> <span id="empresaNIT">-</span></p>
              <p id="empresaDireccion">Direcci√≥n</p>
              <p><strong>Tel:</strong> <span id="empresaTelefono">-</span></p>
            </div>
            <div class="fecha-factura" style="text-align: right;">
              <div style="display: flex; justify-content: flex-end; align-items: center; gap: 10px;">
                <h2 style="margin: 0;">Factura</h2>
                <button class="no-print" onclick="window.location.href='ventas.html'" style="padding: 6px 12px; font-size: 14px;">
                  ‚¨ÖÔ∏è Regresar a Ventas
                </button>
              </div>
              <p><strong>Fecha:</strong> <span id="facturaFecha"></span></p>
              <p><strong>NIT Cliente:</strong> <span id="facturaClienteNIT">C/F</span></p>
            </div>
          </div>

          <table class="factura-tabla">
            <thead>
              <tr>
                <th>Producto</th>
                <th>Cantidad</th>
                <th>Precio Unitario</th>
                <th>Subtotal</th>
              </tr>
            </thead>
            <tbody id="facturaBody"></tbody>
            <tfoot>
              <tr>
                <td colspan="3"><strong>Total</strong></td>
                <td id="facturaTotal">Q0.00</td>
              </tr>
            </tfoot>
          </table>

          <p class="agradecimiento">Gracias por su preferencia. ¬°Vuelva pronto!</p>

          <div class="factura-botones no-print">
            <button onclick="window.print()">üñ®Ô∏è Imprimir factura</button>
            <button onclick="window.location.href='ventas.html'">‚¨ÖÔ∏è Volver a Ventas</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { db } from './firebase.js';
    import {
      collection, getDocs, addDoc, updateDoc, doc, getDoc
    } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-auth.js";

    const auth = getAuth();
    const carrito = JSON.parse(localStorage.getItem("carrito")) || [];
    let productosBD = [];

    const tablaResumen = document.querySelector("#tablaResumen tbody");
    const totalVenta = document.getElementById("totalVenta");
    const mensaje = document.getElementById("mensaje");

    const formatter = new Intl.NumberFormat('es-MX', {
      style: 'currency',
      currency: 'GTQ'
    });

    function mostrarOpcionesPermitidas(rolUsuario) {
      const links = document.querySelectorAll('.sidebar a');
      links.forEach(link => {
        const rolesPermitidos = link.getAttribute('data-rol');
        if (!rolesPermitidos || (rolesPermitidos !== "todos" && !rolesPermitidos.includes(rolUsuario))) {
          link.style.display = "none";
        }
      });
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) return window.location.href = "index.html";

      const ref = doc(db, "usuarios", user.uid);
      const snap = await getDoc(ref);

      if (!snap.exists()) return window.location.href = "index.html";

      const data = snap.data();
      document.getElementById("usuario-logueado").textContent = `Bienvenido, ${data.nombre}`;
      document.getElementById("rol-logueado").textContent = `Rol: ${data.rol}`;
      document.getElementById("fecha-hoy").textContent = new Date().toLocaleDateString('es-ES');

      mostrarOpcionesPermitidas(data.rol);
      if (!["Administrador", "Vendedor", "Bodega"].includes(data.rol)) {
        alert("‚ö†Ô∏è No tienes permisos para acceder.");
        return window.location.href = "dashboard.html";
      }

      await cargarInventario();
      renderizarTabla();
    });

    async function cargarInventario() {
      const snapshot = await getDocs(collection(db, "inventario"));
      productosBD = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    }

    function renderizarTabla() {
      tablaResumen.innerHTML = '';
      let total = 0;

      carrito.forEach(item => {
        const subtotal = item.cantidad * item.precio;
        total += subtotal;

        const row = tablaResumen.insertRow();
        row.innerHTML = `
          <td>${item.nombre}</td>
          <td>${item.cantidad}</td>
          <td>${formatter.format(item.precio)}</td>
          <td>${formatter.format(subtotal)}</td>
        `;
      });

      totalVenta.textContent = formatter.format(total);
    }

    async function cargarDatosEmpresa() {
      try {
        const ref = doc(db, "configuracion_factura", "empresa");
        const snap = await getDoc(ref);

        if (snap.exists()) {
          const data = snap.data();
          document.getElementById("empresaNombre").textContent = data.nombre || "Mi Empresa";
          document.getElementById("empresaNIT").textContent = data.nit || "-";
          document.getElementById("empresaDireccion").textContent = data.direccion || "-";
          document.getElementById("empresaTelefono").textContent = data.telefono || "-";
        }
      } catch (err) {
        console.error("‚ùå Error al cargar datos de empresa:", err);
      }
    }

    function mostrarFactura() {
      const facturaBody = document.getElementById("facturaBody");
      const facturaTotal = document.getElementById("facturaTotal");
      const facturaFecha = document.getElementById("facturaFecha");

      facturaBody.innerHTML = '';
      let total = 0;

      carrito.forEach(item => {
        const subtotal = item.cantidad * item.precio;
        total += subtotal;

        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${item.nombre}</td>
          <td>${item.cantidad}</td>
          <td>${formatter.format(item.precio)}</td>
          <td>${formatter.format(subtotal)}</td>
        `;
        facturaBody.appendChild(row);
      });

      facturaFecha.textContent = new Date().toLocaleString();
      facturaTotal.textContent = formatter.format(total);

      const usarCF = document.getElementById("usarCF").checked;
      const clienteNIT = document.getElementById("clienteNIT").value.trim();
      document.getElementById("facturaClienteNIT").textContent = usarCF ? "C/F" : (clienteNIT || "C/F");

      cargarDatosEmpresa();
      document.getElementById("factura").style.display = "block";
    }

    document.getElementById("btnConfirmarVenta").addEventListener("click", async () => {
      if (carrito.length === 0) {
        mensaje.textContent = "‚ö†Ô∏è El carrito est√° vac√≠o.";
        mensaje.className = "mensaje error";
        return;
      }

      try {
        for (const item of carrito) {
          const productoBD = productosBD.find(p => p.id === item.id);
          if (!productoBD) throw new Error(`Producto "${item.nombre}" no existe.`);
          if (productoBD.cantidad < item.cantidad) {
            throw new Error(`Stock insuficiente para "${item.nombre}".`);
          }

          await addDoc(collection(db, "ventas"), {
            producto: item.nombre,
            cantidad: item.cantidad,
            total: item.cantidad * item.precio,
            fecha: new Date()
          });

          await updateDoc(doc(db, "inventario", item.id), {
            cantidad: productoBD.cantidad - item.cantidad
          });
        }

        localStorage.removeItem("carrito");
        mensaje.textContent = "‚úÖ Venta registrada con √©xito.";
        mensaje.className = "mensaje success";
        tablaResumen.innerHTML = '';
        totalVenta.textContent = "Q0.00";
        mostrarFactura();
      } catch (err) {
        console.error(err);
        mensaje.textContent = "‚ùå Error: " + err.message;
        mensaje.className = "mensaje error";
      }
    });

    window.cerrarSesion = function () {
      localStorage.clear();
      auth.signOut().then(() => window.location.href = "index.html");
    };
  </script>
</body>
</html>
